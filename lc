#!/usr/bin/env python3

import argparse
import re
import sys
from pathlib import Path


def _parse_problem_number(raw: str) -> int:
    match = re.search(r"\d+", raw)
    if not match:
        raise ValueError(f"invalid problem number: {raw!r}")
    return int(match.group(0))


def _slugify(title: str) -> str:
    slug = title.strip().lower()
    slug = re.sub(r"[^a-z0-9]+", "-", slug)
    slug = slug.strip("-")
    return slug or "untitled"


def _bucket_dir(problem_number: int, width: int) -> str:
    start = (problem_number // 1000) * 1000
    end = start + 999
    return f"{start:0{width}d}-{end:0{width}d}"


def main(argv: list[str]) -> int:
    parser = argparse.ArgumentParser(
        prog="lc",
        description="Generate a new problem folder scaffold (defaults: leetcode + python).",
    )
    parser.add_argument(
        "--category",
        "-c",
        default="leetcode",
        help="problem category (default: leetcode)",
    )
    parser.add_argument(
        "--lang",
        "-l",
        default="python",
        choices=["python", "go", "java"],
        help="solution language folder to create (default: python)",
    )
    parser.add_argument(
        "--force",
        action="store_true",
        help="overwrite the solution file if it already exists",
    )
    parser.add_argument("number", help="problem number, e.g. 312 or 312.")
    parser.add_argument(
        "title_and_link",
        nargs=argparse.REMAINDER,
        help="problem title words followed by the problem link",
    )

    args = parser.parse_args(argv)

    if len(args.title_and_link) < 2:
        parser.print_usage(sys.stderr)
        print(
            "Example: lc 312. Burst Balloons https://leetcode.cn/problems/burst-balloons/description/",
            file=sys.stderr,
        )
        return 2

    try:
        problem_number = _parse_problem_number(args.number)
    except ValueError as e:
        print(f"Error: {e}", file=sys.stderr)
        return 2

    title = " ".join(args.title_and_link[:-1]).strip()
    link = args.title_and_link[-1].strip()

    if not title:
        print("Error: empty problem title.", file=sys.stderr)
        return 2
    if not link:
        print("Error: empty problem link.", file=sys.stderr)
        return 2

    width = max(4, len(str(problem_number)))
    pid = f"{problem_number:0{width}d}"
    slug = _slugify(title)
    bucket = _bucket_dir(problem_number, width)

    repo_root = Path(__file__).resolve().parent
    problem_dir = repo_root / "problems" / args.category / bucket / f"{pid}-{slug}"
    if problem_dir.exists() and not problem_dir.is_dir():
        print(f"Error: {problem_dir} exists and is not a directory.", file=sys.stderr)
        return 1

    lang_dir = problem_dir / args.lang
    lang_dir.mkdir(parents=True, exist_ok=True)

    ext_by_lang = {"python": "py", "go": "go", "java": "java"}
    ext = ext_by_lang[args.lang]
    solution_path = lang_dir / f"solution.{ext}"

    perf_template = "xx ms Beats xx%\nxx MB Beats xx%"

    stub_by_lang = {
        "python": (
            f'"""\n{link}\n{perf_template}\n"""\n\n'
            "from typing import *\n\n\n"
            "class Solution:\n"
            "    # TODO: paste the LeetCode method signature here and implement.\n"
            "    pass\n"
        ),
        "go": (
            f"// {link}\n// {perf_template.replace(chr(10), chr(10) + '// ')}\n\n"
            "package main\n\n"
            "// TODO: implement\n"
        ),
        "java": (
            f"// {link}\n// {perf_template.replace(chr(10), chr(10) + '// ')}\n\n"
            "class Solution {\n"
            "    // TODO: implement\n"
            "}\n"
        ),
    }

    if solution_path.exists() and not args.force:
        print(f"Problem folder: {problem_dir}")
        print(f"exists:  {solution_path}")
        return 0

    solution_path.write_text(stub_by_lang[args.lang], encoding="utf-8")

    print(f"Problem folder: {problem_dir}")
    print(f"created: {solution_path}")
    return 0


if __name__ == "__main__":
    raise SystemExit(main(sys.argv[1:]))
